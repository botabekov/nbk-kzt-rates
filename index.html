<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Курсы НБК (USD/EUR/RUB)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1020;
      --card:#111a33;
      --line:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.70);
      --accent:#6aa6ff;
      --accent2:#4b89ff;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --radius:16px;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, rgba(106,166,255,.25), transparent 60%),
                  radial-gradient(900px 500px at 80% 0%, rgba(245,158,11,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:26px 16px 40px}
    .top{
      display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:16px;
    }
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .sub{margin:6px 0 0;color:var(--muted);line-height:1.45;max-width:700px}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .controls{
      padding:14px;
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      background: rgba(0,0,0,.10);
      border-bottom:1px solid var(--line);
    }
    .field{display:flex;flex-direction:column;gap:6px;min-width:180px}
    label{font-size:12px;color:var(--muted)}
    input[type="date"]{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      min-width:180px;
    }
    .btn{
      cursor:pointer;
      border:0;
      padding:11px 14px;
      border-radius:12px;
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      color:#081028;
      font-weight:700;
      transition: transform .08s ease;
      margin-top:18px;
      box-shadow: 0 10px 30px rgba(106,166,255,.25);
    }
    .btn:active{transform: translateY(1px)}
    .meta{
      margin-left:auto;
      display:flex;flex-direction:column;gap:6px;
      min-width:320px;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      width:fit-content;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
    .dot.ok{background:var(--good)}
    .dot.bad{background:var(--bad)}
    a{color:var(--accent)}

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
      padding:14px;
      border-bottom:1px solid var(--line);
    }
    .mini{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px;
    }
    .miniTop{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .ccy{font-weight:800;letter-spacing:.04em}
    .name{color:var(--muted);font-size:12px;margin-top:2px}
    .rate{font-size:18px;font-weight:800}
    .subrate{margin-top:6px;color:var(--muted);font-size:12px}
    .chg.up{color:var(--good);font-weight:700}
    .chg.down{color:var(--bad);font-weight:700}
    .chg.zero{color:var(--muted);font-weight:700}

    .tableWrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:760px}
    thead th{
      position:sticky;top:0;
      background: rgba(16,24,48,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      color:rgba(234,240,255,.85);
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
      padding:12px 12px;
      text-align:left;
      white-space:nowrap;
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      color:rgba(234,240,255,.92);
      font-size:13px;
      white-space:nowrap;
    }
    tbody tr:hover td{background: rgba(255,255,255,.04)}
    .num{text-align:right;font-variant-numeric: tabular-nums}
    .foot{padding:12px 14px;color:var(--muted);font-size:12px;line-height:1.45}

    @media (max-width: 820px){
      .grid{grid-template-columns:1fr}
      .meta{min-width:unset;width:100%}
      .btn{width:100%}
      .field{min-width:unset;flex:1}
      input[type="date"]{width:100%}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Курсы НБК (KZT): USD / EUR / RUB</h1>
        <p class="sub">Одностраничник на GitHub Pages. Источник: RSS get_rates.cfm (XML). Если CORS блокирует прямой запрос — используем локальный JSON (data/nbk_usd_eur_rub.json).</p>
      </div>
    </div>

    <div class="card">
      <div class="controls">
        <div class="field">
          <label for="date">Дата</label>
          <input id="date" type="date" />
        </div>
        <button class="btn" id="loadBtn">Загрузить</button>

        <div class="meta">
          <div class="pill"><span class="dot" id="statusDot"></span><span id="statusText">Готово</span></div>
          <div class="pill">Источник: <a id="srcLink" href="#" target="_blank" rel="noreferrer">—</a></div>
          <div class="pill">Fallback JSON: <span id="fallbackPath">data/nbk_usd_eur_rub.json</span></div>
        </div>
      </div>

      <div class="grid" id="cards"></div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Код</th>
              <th>Валюта</th>
              <th class="num">Номинал</th>
              <th class="num">Курс (KZT)</th>
              <th class="num">KZT за 1 ед.</th>
              <th class="num">Изменение</th>
              <th>Тренд</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="7" style="color:rgba(234,240,255,.70)">Нажми «Загрузить»</td></tr>
          </tbody>
        </table>
      </div>

      <div class="foot">
        Совет: если выбираешь дату, которая была выходным/праздником, может не быть данных на эту дату — тогда попробуй предыдущий рабочий день.
      </div>
    </div>
  </div>

  <script>
    const TARGET = new Set(["USD","EUR","RUB"]);
    const FALLBACK_JSON = "data/nbk_usd_eur_rub.json";

    const els = {
      date: document.getElementById("date"),
      loadBtn: document.getElementById("loadBtn"),
      tbody: document.getElementById("tbody"),
      cards: document.getElementById("cards"),
      statusDot: document.getElementById("statusDot"),
      statusText: document.getElementById("statusText"),
      srcLink: document.getElementById("srcLink"),
    };

    function setStatus(kind, text){
      els.statusText.textContent = text;
      els.statusDot.classList.remove("ok","bad");
      if(kind === "ok") els.statusDot.classList.add("ok");
      if(kind === "bad") els.statusDot.classList.add("bad");
    }

    function toDDMMYYYY(d){
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yyyy = d.getFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }

    function normNum(s){
      if(s == null) return null;
      const t = String(s).trim().replace(/\s/g,"").replace(",",".");
      const n = Number(t);
      return Number.isFinite(n) ? n : null;
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function chgClass(chg){
      if(chg == null) return "zero";
      if(chg > 0) return "up";
      if(chg < 0) return "down";
      return "zero";
    }

    function render(rows, meta){
      // Карточки (USD/EUR/RUB) — красиво
      const byCode = Object.fromEntries(rows.map(r => [r.code, r]));
      const order = ["USD","EUR","RUB"];
      els.cards.innerHTML = order.map(code => {
        const r = byCode[code];
        if(!r){
          return `
            <div class="mini">
              <div class="miniTop">
                <div>
                  <div class="ccy">${code}</div>
                  <div class="name">—</div>
                </div>
                <div class="chg zero">нет данных</div>
              </div>
              <div class="rate">—</div>
              <div class="subrate">—</div>
            </div>
          `;
        }
        const per1 = (r.rate != null && r.quant) ? (r.rate / r.quant) : null;
        return `
          <div class="mini">
            <div class="miniTop">
              <div>
                <div class="ccy">${escapeHtml(r.code)}</div>
                <div class="name">${escapeHtml(r.name || "")}</div>
              </div>
              <div class="chg ${chgClass(r.chg)}">${r.chg == null ? "—" : (r.chg > 0 ? "+" : "") + r.chg.toFixed(4)}</div>
            </div>
            <div class="rate">${r.rate == null ? "—" : r.rate.toFixed(4)} <span style="color:rgba(234,240,255,.70);font-size:12px;font-weight:700">KZT</span></div>
            <div class="subrate">
              Номинал: <b>${r.quant ?? "—"}</b> · за 1 ед.: <b>${per1 == null ? "—" : per1.toFixed(4)}</b> · тренд: <b>${escapeHtml(r.idx || "—")}</b>
            </div>
          </div>
        `;
      }).join("");

      // Таблица
      if(!rows.length){
        els.tbody.innerHTML = `<tr><td colspan="7" style="color:rgba(234,240,255,.70)">Нет данных</td></tr>`;
        return;
      }

      els.tbody.innerHTML = rows.map(r => {
        const per1 = (r.rate != null && r.quant) ? (r.rate / r.quant) : null;
        const chg = r.chg;
        const chgText = (chg == null) ? "—" : ((chg > 0 ? "+" : "") + chg.toFixed(4));
        return `
          <tr>
            <td><b>${escapeHtml(r.code)}</b></td>
            <td>${escapeHtml(r.name || "—")}</td>
            <td class="num">${r.quant ?? "—"}</td>
            <td class="num">${r.rate == null ? "—" : r.rate.toFixed(4)}</td>
            <td class="num">${per1 == null ? "—" : per1.toFixed(4)}</td>
            <td class="num"><span class="chg ${chgClass(chg)}">${chgText}</span></td>
            <td style="color:rgba(234,240,255,.70)">${escapeHtml(r.idx || "—")}</td>
          </tr>
        `;
      }).join("");
    }

    async function fetchFromNBK(ddmmyyyy){
      const url = `https://nationalbank.kz/rss/get_rates.cfm?fdate=${encodeURIComponent(ddmmyyyy)}&switch=russian`;
      els.srcLink.href = url;
      els.srcLink.textContent = `NBK get_rates.cfm?fdate=${ddmmyyyy}`;

      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(`NBK HTTP ${res.status}`);

      const xmlText = await res.text();
      const xml = new DOMParser().parseFromString(xmlText, "text/xml");
      const items = Array.from(xml.querySelectorAll("item"));

      const rows = items.map(item => {
        const code = item.querySelector("title")?.textContent?.trim() || "";
        if(!TARGET.has(code)) return null;

        const name = item.querySelector("fullname")?.textContent?.trim() || "";
        const rate = normNum(item.querySelector("description")?.textContent); // курс за номинал
        const quant = normNum(item.querySelector("quant")?.textContent) ?? 1;
        const idx = item.querySelector("index")?.textContent?.trim() || "";
        const chg = normNum(item.querySelector("change")?.textContent);

        return { code, name, quant, rate, idx, chg };
      }).filter(Boolean);

      return { rows, meta: { source: "nbk", url } };
    }

    async function fetchFromFallback(){
      const res = await fetch(FALLBACK_JSON, { cache: "no-store" });
      if(!res.ok) throw new Error(`Fallback HTTP ${res.status}`);
      const data = await res.json();
      // ожидаемый формат: { date:"DD.MM.YYYY", rates:[{code,name,quant,rate,idx,chg}] }
      const rows = (data?.rates || []).filter(r => TARGET.has(r.code));
      return { rows, meta: { source: "fallback", date: data?.date || null } };
    }

    async function load(){
      try{
        setStatus("warn", "Загружаю…");

        const d = els.date.value ? new Date(els.date.value) : new Date();
        const ddmmyyyy = toDDMMYYYY(d);

        // 1) пробуем напрямую
        const direct = await fetchFromNBK(ddmmyyyy);
        render(direct.rows, direct.meta);

        if(direct.rows.length === 0){
          setStatus("bad", `Нет данных на ${ddmmyyyy}. Попробуй предыдущий рабочий день.`);
        } else {
          setStatus("ok", `Ок: ${direct.rows.map(r=>r.code).join(", ")} · дата ${ddmmyyyy}`);
        }
      } catch (e) {
        // 2) fallback json
        try{
          const fb = await fetchFromFallback();
          render(fb.rows, fb.meta);
          setStatus("ok", `Ок (fallback): данные из ${FALLBACK_JSON}${fb.meta?.date ? " · дата " + fb.meta.date : ""}`);
          els.srcLink.href = FALLBACK_JSON;
          els.srcLink.textContent = `LOCAL ${FALLBACK_JSON}`;
        } catch (e2) {
          console.error(e, e2);
          setStatus("bad", "Ошибка загрузки (NBK + fallback). Проверь CORS/путь к JSON.");
          els.tbody.innerHTML = `
            <tr>
              <td colspan="7" style="color:rgba(234,240,255,.70)">
                Не получилось получить данные.
                <br>Причины: CORS (браузер блокирует NBK), либо нет файла <b>${FALLBACK_JSON}</b>.
                <br>Решение: включить GitHub Actions (ниже) или положить JSON вручную.
              </td>
            </tr>
          `;
          els.cards.innerHTML = "";
        }
      }
    }

    (function init(){
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,"0");
      const dd = String(now.getDate()).padStart(2,"0");
      els.date.value = `${yyyy}-${mm}-${dd}`;

      els.loadBtn.addEventListener("click", load);
      load();
    })();
  </script>
</body>
</html>
